#################################################################
#### Automations
#################################################################

- alias: 'Plex paused/stopped - normal lights'
  initial_state: true
  trigger:
    platform: state
    entity_id: media_player.plex_81cd37e4b6139e46a9735a145c08213c
    from: 'playing'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: sun.sun
        state: 'below_horizon'
      - condition: state
        entity_id: group.livingroom_lights
        state: 'on'
  action:
    service: scene.turn_on
    entity_id: scene.livingroom_normal

- alias: 'Plex playing - Dimm lights'
  initial_state: true
  trigger:
    platform: state
    entity_id: media_player.plex_81cd37e4b6139e46a9735a145c08213c
    to: 'playing'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: sun.sun
        state: 'below_horizon'
      - condition: state
        entity_id: group.livingroom_lights
        state: 'on'
  action:
    service: scene.turn_on
    entity_id: scene.livingroom_dim

- alias: 'Roku Idle'
  initial_state: true
  trigger:
    platform: state
    entity_id: media_player.living_room_roku
    from: 'playing'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: sun.sun
        state: 'below_horizon'
      - condition: state
        entity_id: group.livingroom_lights
        state: 'on'
  action:
    service: scene.turn_on
    entity_id: scene.livingroom_normal

- alias: 'Roku Playing'
  initial_state: true
  trigger:
    platform: state
    entity_id: media_player.living_room_roku
    to: 'playing'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: sun.sun
        state: 'below_horizon'
      - condition: state
        entity_id: group.livingroom_lights
        state: 'on'
      - condition: template
        value_template: "{{ is_state_attr('media_player.living_room_roku', 'app_name', 'Netflix') }}"
  action:
    service: scene.turn_on
    entity_id: scene.livingroom_dim

- alias: 'Everyone home and gone to bed - Lights out'
  initial_state: true
  trigger:
    - platform: state
      entity_id: device_tracker.livingroomtv
      to: 'not_home'
      for:
        minutes: 5
    - platform: state
      entity_id: sensor.gail,sensor.gervais,group.cam_tracker,group.jen_tracker
      to: 'home'
  condition:
    condition: and
    conditions:
      - condition: time
        after: '22:30:00'
      - condition: state
        entity_id: device_tracker.livingroomtv
        state: 'not_home'
      - condition: state
        entity_id: group.cam_tracker
        state: 'home'
      - condition: state
        entity_id: group.jen_tracker
        state: 'home'
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.gail
            state: 'home'
          - condition: template
            value_template: '{{ distance(states.device_tracker.gail_iphonetracks) > 10 }}'
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.gervais
            state: 'home'
          - condition: template
            value_template: '{{ distance(states.device_tracker.gervais_iphonetracks) > 10 }}'
  action:
    - service: homeassistant.turn_off
      entity_id: automation.timed_lights__movement_front_door
    - service: light.turn_off
    - delay: ' 00:00:04'
    - service: homeassistant.turn_on
      entity_id: automation.timed_lights__movement_front_door

- alias: 'Midnight - Livingroom Lights out'
  initial_state: false
  trigger:
    platform: time
    at: '23:59:59'
  action:
    - service: light.turn_off
      entity_id: group.livingroom_lights

- alias: '2am - Lights out'
  initial_state: true
  trigger:
    platform: time
    at: '02:00:00'
  action:
    - service: homeassistant.turn_off
      entity_id: automation.timed_lights__movement_front_door
    - service: light.turn_off
    - delay: ' 00:00:04'
    - service: homeassistant.turn_on
      entity_id: automation.timed_lights__movement_front_door

- alias: '6pm - heater off'
  initial_state: true
  trigger:
    - platform: time
      at: '18:00:00'
    - platform: time
      at: '18:30:00'
    - platform: time
      at: '19:00:00'
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: '{{ states("sensor.season") != "Summer" }}'
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.gervais
            state: 'home'
          - condition: template
            value_template: '{{ distance(states.device_tracker.gervais_iphonetracks) > 10 }}'
  action:
    service: switch.turn_off
    entity_id:
      - switch.switch0
      - switch.switch2

- alias: 'Sunrise - Lights out'
  initial_state: true
  trigger:
    platform: sun
    event: sunrise
    offset: '+00:10:00'
  action:
    - service: light.turn_off
    - service: switch.turn_off
      entity_id: switch.switch3

- alias: 'Sunset - Lights on'
  initial_state: true
  trigger:
    platform: sun
    event: sunset
    offset: '-00:20:00'
  action:
    - service: light.turn_on
      entity_id:
        - light.bathroom
        - light.kitchen_oven
      data:
        brightness: 255
    - service: light.turn_on
      entity_id: group.outdoor_lights
      data:
        brightness: 255
        transition: 300
    - service: scene.turn_on
      entity_id: scene.livingroom_normal
    - service: switch.turn_on
      entity_id: switch.switch3

- alias: 'Sunset - Office lights on'
  initial_state: true
  trigger:
    platform: sun
    event: sunset
    offset: '-00:20:00'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.yoga
        state: 'home'
      - condition: state
        entity_id: 'binary_sensor.workday_sensor'
        state: 'on'
      - condition: state
        entity_id: group.office_lights
        state: 'off'
  action:
    service: light.turn_on
    entity_id: group.office_lights
    data:
      brightness: 200
      transition: 5

- alias: 'Living room lux low - lights on'
  initial_state: true
  trigger:
    platform: numeric_state
    entity_id: 'sensor.living_room_lux'
    below: '6500'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.livingroomtv
        state: 'home'
      - condition: state
        entity_id: group.livingroom_lights
        state: 'off'
  action:
    service: scene.turn_on
    entity_id: scene.livingroom_normal

- alias: 'Jennifer Home - turn on'
  initial_state: false
  trigger:
    platform: state
    entity_id: group.jen_tracker
    to: 'home'
  action:
    service: switch.turn_on
    entity_id: 'switch.switch1'

- alias: 'Jennifer Away - turn off'
  initial_state: true
  trigger:
    platform: state
    entity_id: group.jen_tracker
    to: 'not_home'
    for:
      minutes: 15
  action:
    service: switch.turn_off
    entity_id: 'switch.switch1'

- alias: 'Midnight - heater off'
  initial_state: true
  trigger:
    - platform: time
      at: '23:59:59'
    - platform: time
      at: '00:29:59'
    - platform: time
      at: '00:59:59'
    - platform: time
      at: '01:29:59'
  condition:
    condition: template
    value_template: '{{ states("sensor.season") != "Summer" }}'
  action:
    service: switch.turn_off
    entity_id: 'switch.switch1'

- alias: 'Window fan on'
  initial_state: false
  trigger:
    platform: template
    value_template: '{{ states.sensor.yr_temperature.state < states.sensor.living_room_temp.state }}'
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: '{{ states.sensor.living_room_temp.state | int >= 20 }}'
      - condition: state
        entity_id: sensor.season
        state: 'Summer'
  action:
    service: switch.turn_on
    entity_id: switch.switch0

- alias: 'Window fan off'
  initial_state: false
  trigger:
    - platform: template
      value_template: '{{ states.sensor.yr_temperature.state > states.sensor.living_room_temp.state }}'
    - platform: template
      value_template: '{{ states.sensor.living_room_temp.state | int < 20 }}'
  condition:
    condition: state
    entity_id: sensor.season
    state: 'Summer'
  action:
    service: switch.turn_off
    entity_id: switch.switch0

- alias: 'Gail away - turn off heater'
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.gail
      from: 'home'
  condition:
    condition: template
    value_template: '{{ states("sensor.season") != "Summer" }}'
  action:
    service: switch.turn_off
    entity_id:
      - switch.switch0
      - switch.switch2

- alias: 'Gail home - turn on heater'
  initial_state: true
  trigger:
      - platform: time
        at: '09:00:01'
      - platform: state
        entity_id: sensor.gail
        to: 'home'
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: '{{ states.sensor.yr_temperature.state < "10" }}'
      - condition: state
        entity_id: sensor.gail
        state: 'home'
      - condition: time
        after: '09:00:00'
      - condition: time
        before: '17:30:00'
      - condition: state
        entity_id: 'binary_sensor.workday_sensor'
        state: 'on'
      - condition: template
        value_template: '{{ states("sensor.season") != "Summer" }}'
  action:
    service: switch.turn_on
    entity_id:
      - switch.switch0
      - switch.switch2

- alias: 'Bedtime'
  initial_state: true
  trigger:
    platform: state
    entity_id: device_tracker.livingroomtv
    to: 'not_home'
    for:
      minutes: 2
  condition:
    condition: and
    conditions:
      - condition: or
        conditions:
        - condition: time
          after: '22:00:00'
        - condition: time
          before: '02:00:00'
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.gail
            state: 'home'
          - condition: template
            value_template: '{{ distance(states.device_tracker.gail_iphonetracks) > 10 }}'
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.gervais
            state: 'home'
          - condition: template
            value_template: '{{ distance(states.device_tracker.gervais_iphonetracks) > 10 }}'
  action:
    - service: light.turn_off
      entity_id:
        - light.bathroom
        - group.kitchen_lights
        - group.office_lights
    - service: homeassistant.turn_on
      entity_id: script.timer_livingroom_off
    - service: switch.turn_off
      entity_id: switch.switch3

- alias: 'GandG not home - turn off bedroom things'
  initial_state: true
  trigger:
    - platform: state
      entity_id: sensor.gail
      from: 'home'
    - platform: state
      entity_id: sensor.gervais
      from: 'home'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: binary_sensor.gail_home
        state: 'off'
      - condition: state
        entity_id: binary_sensor.gervais_home
        state: 'off'
  action:
    - service: light.turn_off
      entity_id: group.bedroom_lights
    - service: switch.turn_off
      entity_id: switch.switch4

- alias: 'Tell Jen to turn off her TV'
  initial_state: true
  trigger:
    platform: time
    at: '08:10:00'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: 'device_tracker.jen_tv'
        state: 'home'
      - condition: state
        entity_id: 'binary_sensor.workday_sensor'
        state: 'on'
  action:
    service: tts.voicerss_say
    entity_id: media_player.jens_broken_chromecast
    data:
      message: 'Time to turn off your TV.'

- alias: 'Timed lights - Movement Front Door'
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.ring_front_door_motion
      to: 'on'
    - platform: state
      entity_id: binary_sensor.ring_front_door_ding
      to: 'on'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: group.outdoor_lights
        state: 'off'
      - condition: state
        entity_id: sun.sun
        state: 'below_horizon'
  action:
    - service: homeassistant.turn_off
      entity_id: automation.timed_lights__movement_front_door
    - service: light.turn_on
      data:
        entity_id:
          - group.outdoor_lights
          - light.computer_room
        brightness: 255
    - delay: '00:10:00'
    - service: light.turn_off
      entity_id:
        - group.outdoor_lights
        - light.computer_room
    - delay: ' 00:00:04'
    - service: homeassistant.turn_on
      entity_id: automation.timed_lights__movement_front_door

- alias: 'Doorbell rang - pause tv'
  initial_state: true
  trigger:
    platform: state
    entity_id: binary_sensor.ring_front_door_ding
    to: 'on'
  action:
    service: media_player.media_play_pause
    entity_id: media_player.plex_81cd37e4b6139e46a9735a145c08213c

- alias: 'Doorbell notify'
  initial_state: true
  trigger:
    - platform: state
      entity_id: binary_sensor.ring_front_door_motion
      to: 'on'
    - platform: state
      entity_id: binary_sensor.ring_front_door_ding
      to: 'on'
  action:
    - service: notify.zulip
      data_template:
        message: >
          :door: {{ trigger.to_state.attributes.friendly_name }}
          {% if trigger.to_state.attributes.device_class == 'motion' %} :wave:
          {% elif trigger.to_state.attributes.device_class == 'occupancy' %} :bell:
          {% endif %}
        title: 'Security Alert'
    - service: rest_command.take_a_picture
    - service: camera.snapshot
      data:
        entity_id: camera.front_door_camera
        filename: '/var/www/html/snapshots/{{ now().strftime("%Y-%m-%d_%H:%M") }}_camera.front_door1.jpg'
    - delay: '00:05:30'
    - service: downloader.download_file
      data_template:
        url: '{{ states.camera.front_door.attributes.video_url }}'
        filename: '{{ now().strftime("%Y-%m-%d_%H:%M") }}_camera.front_door2.mp4'
    - service: camera.snapshot
      data_template:
        entity_id: camera.front_door
        filename: '/var/www/html/snapshots/{{ now().strftime("%Y-%m-%d_%H:%M") }}_camera.front_door2.jpg'

- alias: 'Timed lights - Movement in Livingroom'
  initial_state: true
  trigger:
    platform: state
    entity_id: binary_sensor.livingroom_motion
    to: 'on'
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: group.livingroom_lights
        state: 'off'
      - condition: state
        entity_id: sun.sun
        state: 'below_horizon'
  action:
    service: homeassistant.turn_on
    entity_id: script.timed_livingroom

- alias: 'set sabnzb speed limit'
  initial_state: true
  trigger:
    - platform: state
      entity_id: group.family
    - platform: 'time'
      at: '10:00:00'
    - platform: 'time'
      at: '18:00:00'
    - platform: 'time'
      at: '02:00:00'
  action:
    service: rest_command.sabnzb_api

- alias: 'home presence notification'
  initial_state: true
  trigger:
    platform: state
    entity_id: group.cam_tracker,group.jen_tracker,group.grant_tracker
  condition:
    condition: numeric_state
    entity_id: 'sensor.hass_uptime'
    above: '.01'
  action:
    service: notify.zulip
    data_template:
      message: >
        :{{ trigger.to_state.attributes.friendly_name | lower }}:
        {{ trigger.to_state.attributes.friendly_name }} has
        {%- if trigger.to_state.state == 'home' %} entered
        {%- else %} exited
        {%- endif %} home.
      title: 'Family Location'

- alias: 'phones presence notification'
  initial_state: true
  trigger:
      - platform: state
        entity_id: sensor.gail,sensor.gervais
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: 'sensor.hass_uptime'
        above: '.01'
      - condition: template
        value_template: '{{ trigger.from_state.state != trigger.to_state.state }}'
  action:
    service: notify.zulip
    data_template:
      message: >
        :{{ trigger.to_state.attributes.friendly_name | lower }}:
        {{ trigger.to_state.attributes.friendly_name }} has
        {%- if trigger.from_state.state == 'not_home' or trigger.from_state.state == 'Away' %} entered {{ trigger.to_state.state }}.
        {%- else %} exited {{ trigger.from_state.state }}.
        {%- endif %}
      title: 'Family Location'

- alias: 'current weather notification'
  initial_state: true
  trigger:
    platform: state
    entity_id: sensor.pws_weather
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: 'sensor.hass_uptime'
        above: '.01'
      - condition: template
        value_template: '{{ trigger.to_state.state != trigger.from_state.state }}'
  action:
    service: notify.zulip
    data_template:
      message: >
        []({{ states.sensor.pws_weather.attributes.entity_picture }})
        **Current Weather Condition:** {{ states.sensor.pws_weather.state }}

        **Current Tempurature:** {{ states.sensor.pws_temp_c.state }}{{ states.sensor.pws_temp_c.attributes.unit_of_measurement }}

        {% if states("sensor.season") == "Winter" %}**{{ states.sensor.pws_feelslike_c.attributes.friendly_name }}:** {{ states.sensor.pws_feelslike_c.state }}{{ states.sensor.yr_temperature.attributes.unit_of_measurement }}
        {% elif states("sensor.season") == "Summer" %}**{{ states.sensor.pws_heat_index_c.attributes.friendly_name }}:** {{ states.sensor.pws_heat_index_c.state }}{{ states.sensor.pws_heat_index_c.attributes.unit_of_measurement }}
        {% endif %}
      title: 'Weather'

- alias: 'current UV index notification'
  initial_state: true
  trigger:
    platform: numeric_state
    entity_id: sensor.pws_uv
    above: '5'
  condition:
    condition: numeric_state
    entity_id: 'sensor.hass_uptime'
    above: '.01'
  action:
    service: notify.zulip
    data:
      message: >
        :smiling_face_with_sunglasses: UV Index is {{ states.sensor.pws_uv.state }}. You better put on some sunscreen!
      title: 'Weather'

- alias: 'weather alert notification'
  initial_state: true
  trigger:
    platform: state
    entity_id: sensor.pws_alerts
  condition:
    condition: and
    conditions:
      - condition: numeric_state
        entity_id: 'sensor.hass_uptime'
        above: '.01'
      - condition: template
        value_template: '{{ trigger.from_state.state != "unknown" }}'
      - condition: template
        value_template: '{{ trigger.to_state.state != trigger.from_state.state }}'
  action:
    service: notify.zulip
    data:
      message: >
        :warning: :droplet: :cloud_with_lightning: :cloud_with_lightning_and_rain: :fog: :cloud_with_rain: :cloud_with_snow: :snowflake: :warning:

        ---

        **{{ states.sensor.pws_alerts.attributes.Description }}**

        ---

        {{ states.sensor.pws_alerts.attributes.Message }}
      title: 'Weather'

- alias: 'weather forecast notification'
  initial_state: true
  trigger:
    platform: time
    at: '08:00:00'
  action:
    service: notify.zulip
    data:
      message: >
        []({{ states.sensor.pws_weather.attributes.entity_picture }})
        **Today's Forecast:** {{ states.sensor.pws_weather.state }}

        **High:** {{ states.sensor.yweather_temperature_max.state }}{{ states.sensor.yr_temperature.attributes.unit_of_measurement }}

        **Low:** {{ states.sensor.yweather_temperature_min.state }}{{ states.sensor.yr_temperature.attributes.unit_of_measurement }}
      title: 'Weather'

- alias: 'drive is filling'
  initial_state: true
  trigger:
    - platform: template
      value_template: '{{ states.sensor.disk_used_mediacracker.state | int >= 95 }}'
    - platform: template
      value_template: '{{ states.sensor.disk_used_mediagrapes.state | int >= 95 }}'
  action:
    service: notify.zulip
    data:
      message: >
        :warning:
        {% if trigger.to_state.attributes.friendly_name == 'Disk Use /media/cracker' %} Movie
        {% elif trigger.to_state.attributes.friendly_name == 'Disk Use /media/grapes' %} TV
        {% endif %}
        drive is almost full.
      title: 'Alert'

- alias: 'turn off livingroom tv when idle'
  initial_state: true
  trigger:
    - platform: state
      entity_id: media_player.plex_81cd37e4b6139e46a9735a145c08213c
      to: 'idle'
      for:
        minutes: 20
    - platform: state
      entity_id: media_player.living_room_roku
      to: 'idle'
      for:
        minutes: 20
  condition:
    condition: and
    conditions:
      - condition: state
        entity_id: device_tracker.retropie
        state: 'not_home'
      - condition: state
        entity_id: device_tracker.livingroomtv
        state: 'home'
  action:
    service: switch.turn_off
    entity_id: switch.tv_power

- alias: 'Gail away - sonos speaker - set sleep timer'
  initial_state: true
  trigger:
    platform: state
    entity_id: sensor.gail
    from: 'home'
  action:
    service: media_player.sonos_set_sleep_timer
    data:
      entity_id: media_player.office
      sleep_time: 900

- alias: 'Gail home - sonos speaker - clear sleep timer'
  initial_state: true
  trigger:
    platform: state
    entity_id: sensor.gail
    to: 'home'
  action:
    service: media_player.sonos_clear_sleep_timer
    entity_id: media_player.office

- alias: 'Pause sonos every 2 minutes if Gail away'
  initial_state: true
  trigger:
    platform: time
    minutes: '/2'
    seconds: 0
  condition:
    condition: state
    entity_id: sensor.gail
    state: 'not_home'
  action:
    service: media_player.media_pause
    entity_id: media_player.office

- alias: 'Turn on heater in bedroom'
  initial_state: true
  trigger:
    - platform: template
      value_template: '{{ states.sensor.bed_room_temp.state|int < 15 }}'
    - platform: time
      at: '22:00:00'
  condition:
    condition: and
    conditions:
      - condition: template
        value_template: '{{ states.sensor.bed_room_temp.state|int < 17 }}'
      - condition: template
        value_template: '{{ states("sensor.season") != "Summer" }}'
      - condition: time
        after: '21:30:00'
      - condition: time
        before: '23:59:59'
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.gail
            state: 'home'
          - condition: template
            value_template: '{{ distance(states.device_tracker.gail_iphonetracks) > 10 }}'
      - condition: or
        conditions:
          - condition: state
            entity_id: sensor.gervais
            state: 'home'
          - condition: template
            value_template: '{{ distance(states.device_tracker.gervais_iphonetracks) > 10 }}'
  action:
    service: switch.turn_on
    entity_id: switch.switch4

- alias: 'Turn off heater in bedroom'
  initial_state: true
  trigger:
    platform: template
    value_template: '{{ states.sensor.bed_room_temp.state|int >= 17 }}'
  action:
    service: switch.turn_off
    entity_id: switch.switch4
